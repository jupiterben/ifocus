# GitHub 登录状态持久化 - 测试指南

## 测试目的

验证用户无需每次启动应用都重新登录 GitHub。

## 测试准备

1. 确保应用已构建：`npm run build`
2. 确保 `.env` 文件中配置了 `GITHUB_CLIENT_SECRET`
3. 准备一个 GitHub 账号用于测试

## 测试步骤

### 测试 1: 首次登录并保存状态

1. **启动应用**
   ```bash
   npm run tauri:dev
   ```

2. **进行首次登录**
   - 点击右上角"⚙️ 设置"按钮
   - 找到"🔐 GitHub 数据同步"部分
   - 点击"🔑 使用 GitHub 登录"按钮
   - 浏览器打开 GitHub 授权页面
   - 授权应用
   - 自动返回到 iFocus 应用

3. **验证登录成功**
   - 设置页面应显示："已登录: [你的用户名]"
   - 应该看到"📤 上传到云端"和"📥 从云端下载"按钮
   - 打开浏览器开发者工具（如果在 Web 环境）或查看 localStorage
   - 应该能看到以下项：
     - `github_access_token`: 一个长字符串
     - `github_user`: 用户信息 JSON
   - 控制台应输出：`✅ GitHub 登录成功: [用户名]`

4. **关闭应用**
   - 完全关闭 iFocus 应用

### 测试 2: 重新启动后自动登录

1. **重新启动应用**
   ```bash
   npm run tauri:dev
   ```

2. **观察控制台输出**
   - 应该看到：`✅ Token 验证成功，自动登录`
   - 不应该看到任何错误信息

3. **打开设置页面**
   - 点击"⚙️ 设置"按钮
   - "🔐 GitHub 数据同步"部分应该：
     - 直接显示"已登录: [你的用户名]"
     - **不需要**重新点击登录按钮
     - 可以直接使用"上传"和"下载"功能

4. **测试同步功能**
   - 添加一些任务
   - 点击"📤 上传到云端"
   - 应该显示"数据已同步到 GitHub"
   - 这证明 token 仍然有效

### 测试 3: Token 失效处理

1. **手动撤销 GitHub 授权**
   - 打开浏览器访问：https://github.com/settings/applications
   - 找到"iFocus"应用（或你的 OAuth App 名称）
   - 点击"Revoke"撤销授权

2. **重新启动应用**
   ```bash
   npm run tauri:dev
   ```

3. **验证失效处理**
   - 控制台应该输出：`⚠️ Token 已失效，已清除登录状态`
   - 打开设置页面，应该显示："登录已过期，请重新登录"
   - 应该看到"🔑 使用 GitHub 登录"按钮
   - localStorage 中的 token 应该被清除

4. **重新登录**
   - 再次点击"🔑 使用 GitHub 登录"
   - 完成 OAuth 授权
   - 登录状态应该恢复

### 测试 4: 多次启动验证

1. **连续启动和关闭应用 5 次**
   - 每次启动都应该自动登录
   - 不需要重新授权
   - 控制台持续输出：`✅ Token 验证成功，自动登录`

2. **验证数据持久性**
   - 添加任务后关闭应用
   - 重新启动，任务应该还在
   - 登录状态应该保持

## 预期结果

### ✅ 成功标准

1. **首次登录后，token 成功保存到 localStorage**
2. **重新启动应用时，自动验证并登录，无需手动操作**
3. **Token 失效时，自动清除并提示用户重新登录**
4. **控制台日志清晰显示验证过程**
5. **设置页面正确显示登录状态**

### ❌ 失败场景

| 场景 | 症状 | 可能原因 |
|------|------|---------|
| 重启后未自动登录 | 设置页面要求重新登录 | `validateToken` 未执行或失败 |
| Token 失效但未清除 | 同步操作失败，显示 401 错误 | 错误处理逻辑有问题 |
| 首次登录后 token 未保存 | 重启后需要重新登录 | `storeToken` 未调用 |
| 验证时卡住 | 设置页面一直显示"验证中" | API 请求超时或未处理异常 |

## 调试技巧

### 查看 localStorage

在浏览器开发者工具中：
```javascript
// 查看存储的 token
localStorage.getItem('github_access_token')

// 查看用户信息
JSON.parse(localStorage.getItem('github_user'))

// 清除所有 GitHub 相关数据
localStorage.removeItem('github_access_token')
localStorage.removeItem('github_user')
localStorage.removeItem('github_gist_id')
```

### 查看控制台日志

关键日志标记：
- `✅ Token 验证成功，自动登录` - 验证成功
- `⚠️ Token 已失效，已清除登录状态` - Token 失效
- `🔄 正在调用 Tauri 后端` - OAuth 回调处理
- `💾 Token 和用户信息已存储` - 登录成功并保存

### 测试 Token 有效性

手动测试 token：
```bash
# 替换 YOUR_TOKEN 为实际的 token
curl -H "Authorization: token YOUR_TOKEN" https://api.github.com/user
```

如果返回 200 和用户信息，token 有效；如果返回 401，token 失效。

## 已知问题

1. **首次启动验证可能较慢**
   - 原因：需要请求 GitHub API 验证 token
   - 解决：添加了"正在验证登录状态..."提示

2. **网络异常时验证失败**
   - 原因：无法连接到 GitHub API
   - 影响：会清除 token，用户需要重新登录
   - 改进建议：区分网络错误和 token 失效

## 相关文件

- `src/services/githubSync.ts` - Token 管理和验证逻辑
- `src/hooks/useGitHubSync.ts` - 自动验证 hook
- `src/components/Settings.tsx` - UI 显示
- `dev_doc/登录状态持久化.md` - 功能说明文档

