# iFocus 单实例配置说明

## ✅ 已实现

iFocus 现在配置为**单实例应用**，同一时间只能运行一个实例。

### 实现方式

使用 `single-instance` crate 检测是否已有实例运行：

```rust
// src-tauri/src/main.rs
let instance = SingleInstance::new("ifocus-app").unwrap();
if !instance.is_single() {
    eprintln!("iFocus 已经在运行中，只允许运行一个实例");
    std::process::exit(1);
}
```

## 🎯 使用场景

### 1. 防止重复启动

用户多次点击应用图标时，不会创建多个窗口，而是：
- ❌ 阻止第二个实例启动
- ✅ 保持原实例继续运行

### 2. GitHub OAuth 回调

当浏览器通过 `ifocus://auth/callback` 调用应用时：
- ✅ 如果应用已运行，回调会被现有实例接收
- ✅ Deep link 监听器会处理 OAuth 授权码
- ✅ 自动完成登录流程

### 3. Deep Link 处理

浏览器重定向到 `ifocus://` 协议时：
- ✅ 操作系统会尝试启动应用
- ✅ 单实例检测生效
- ✅ 已运行的实例接收 URL 参数

## 📋 测试步骤

### 测试 1：防止重复启动

1. 启动 iFocus
2. 再次点击应用图标或快捷方式
3. **预期结果**：第二次启动会立即退出，不会创建新窗口

### 测试 2：OAuth 回调

1. 启动 iFocus
2. 点击 "使用 GitHub 登录"
3. 在浏览器中完成授权
4. GitHub 重定向到 `ifocus://auth/callback?code=xxx`
5. **预期结果**：
   - 已运行的 iFocus 窗口接收回调
   - 自动完成登录
   - 不会启动新的应用实例

### 测试 3：最小化状态下的回调

1. 启动 iFocus 并最小化到托盘
2. 在浏览器打开 `ifocus://auth/callback?code=test`
3. **预期结果**：
   - 应用不会创建新实例
   - 现有实例会处理 URL

## 🔍 技术细节

### 单实例机制

`single-instance` crate 通过以下方式实现：

**Windows**: 使用命名互斥锁 (Named Mutex)
```
\\.\ifocus-app
```

**Linux/macOS**: 使用文件锁
```
/tmp/ifocus-app.lock  (Linux)
/var/tmp/ifocus-app.lock  (macOS)
```

### Deep Link 处理流程

```
┌─────────────────────────────────────────────┐
│  用户在浏览器授权 GitHub                    │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  GitHub 重定向到 ifocus://auth/callback     │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  操作系统检测到 ifocus:// 协议              │
│  尝试启动 iFocus.exe                        │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  单实例检测                                 │
│  - 检测到已有实例运行                       │
│  - 新进程退出                               │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  已运行的实例继续处理                       │
│  - Deep link 插件接收 URL                   │
│  - 触发 onOpenUrl 事件                      │
│  - 前端处理 OAuth 回调                      │
└─────────────────────────────────────────────┘
```

## ⚠️ 注意事项

### 1. 开发模式

在开发模式下 (`pnpm tauri:dev`)，每次重启都会创建新实例。如果遇到"已在运行"错误：

```bash
# 停止所有 iFocus 进程
taskkill /F /IM ifocus.exe  # Windows
pkill ifocus                 # Linux/macOS

# 重新启动
pnpm tauri:dev
```

### 2. 构建版本

构建的应用 (`pnpm tauri:build`) 会严格执行单实例限制。

### 3. OAuth 回调超时

如果 OAuth 回调时应用未运行：
- 操作系统会尝试启动应用
- 应用启动后会接收到 URL 参数
- Deep link 监听器会处理回调

如果应用已关闭，可能需要：
1. 手动启动应用
2. 重新进行 OAuth 授权流程

## 🚀 优势

1. **用户体验更好**：避免混淆多个窗口
2. **数据一致性**：所有操作在同一实例中进行
3. **OAuth 流程简化**：回调自动路由到运行中的实例
4. **资源占用更少**：不会创建多余进程

## 📝 相关文件

- `src-tauri/Cargo.toml` - 添加了 `single-instance` 依赖
- `src-tauri/src/main.rs` - 实现单实例检测
- `src/hooks/useGitHubSync.ts` - 监听 deep link 事件

## 🔧 自定义配置

如需修改实例标识符：

```rust
// src-tauri/src/main.rs
let instance = SingleInstance::new("your-custom-id").unwrap();
```

**注意**：修改标识符后，旧版本和新版本可以同时运行。

