# GitHub 认证层架构设计

## 设计目标

创建一个灵活的认证抽象层，使 iFocus 应用能够同时支持：
- **桌面端（Tauri）**：使用 deep-link 回调
- **Web 端（服务器部署）**：使用传统的 HTTP 回调

## 架构概览

```
┌─────────────────────────────────────────────────────┐
│                   应用层                             │
│  (Components, Hooks, Business Logic)                │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│           GitHub Sync Service V2                    │
│  (统一的数据同步接口，不关心具体实现)                 │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│            Auth Factory (工厂模式)                   │
│  自动检测环境并创建相应的 Auth Provider               │
└─────────┬───────────────────────────┬───────────────┘
          │                           │
┌─────────▼─────────┐       ┌────────▼──────────┐
│ TauriAuthProvider │       │ WebAuthProvider   │
│  (桌面端实现)      │       │  (Web端实现)      │
└─────────┬─────────┘       └────────┬──────────┘
          │                           │
┌─────────▼─────────┐       ┌────────▼──────────┐
│TauriStorageProvider│      │LocalStorageProvider│
│  (Tauri 存储)      │       │  (浏览器存储)     │
└───────────────────┘       └───────────────────┘
```

## 核心接口

### 1. IAuthProvider（认证提供者接口）

定义所有认证提供者必须实现的方法：

```typescript
interface IAuthProvider {
  // 初始化认证（检查已存储的 token）
  initialize(): Promise<AuthState>;
  
  // 启动登录流程
  startLogin(): Promise<void>;
  
  // 处理 OAuth 回调
  handleCallback(code: string): Promise<AuthResult>;
  
  // 验证 token 是否有效
  validateToken(token: string): Promise<boolean>;
  
  // 登出
  logout(): void;
  
  // 获取当前状态
  getAuthState(): AuthState;
}
```

### 2. IStorageProvider（存储提供者接口）

定义统一的数据存储行为：

```typescript
interface IStorageProvider {
  setToken(token: string): void;
  getToken(): string | null;
  setUser(user: GitHubUser): void;
  getUser(): GitHubUser | null;
  setGistId(gistId: string): void;
  getGistId(): string | null;
  clear(): void;
}
```

## 实现细节

### 桌面端（Tauri）实现

#### TauriAuthProvider

- **登录启动**：使用 `@tauri-apps/plugin-shell` 打开浏览器
- **回调处理**：监听 `ifocus://auth/callback` deep-link
- **Token 交换**：调用 Rust 后端的 `handle_github_oauth` 命令
- **安全性**：Client Secret 存储在 Rust 后端，前端不可见

```typescript
// 启动登录
async startLogin(): Promise<void> {
  const authUrl = `https://github.com/login/oauth/authorize?...`;
  await open(authUrl); // 打开浏览器
}

// 处理回调
async handleCallback(code: string): Promise<AuthResult> {
  const { invoke } = await import('@tauri-apps/api/core');
  // 调用 Rust 后端
  const result = await invoke('handle_github_oauth', { code });
  return result;
}
```

#### TauriStorageProvider

- 当前使用 `localStorage` 作为后备方案
- **未来优化**：迁移到 `@tauri-apps/plugin-store` 实现加密存储

### Web 端实现

#### WebAuthProvider

- **登录启动**：直接重定向到 GitHub OAuth 页面
- **回调处理**：GitHub 回调到 `/auth/callback` 路由
- **Token 交换**：调用后端 API `/api/auth/github/callback`
- **安全性**：Client Secret 存储在服务器端

```typescript
// 启动登录
async startLogin(): Promise<void> {
  const authUrl = `https://github.com/login/oauth/authorize?...`;
  window.location.href = authUrl; // 重定向
}

// 处理回调
async handleCallback(code: string): Promise<AuthResult> {
  // 调用后端 API
  const response = await fetch('/api/auth/github/callback', {
    method: 'POST',
    body: JSON.stringify({ code }),
  });
  return await response.json();
}
```

#### LocalStorageProvider

- 使用浏览器的 `localStorage` API
- 适用于纯前端应用和 Web 环境

## 使用方式

### 应用启动时初始化

```typescript
import { getAuthProvider } from './services/auth';

// 在应用启动时
const authProvider = getAuthProvider();
const authState = await authProvider.initialize();

if (authState.isLoggedIn) {
  console.log('自动登录成功:', authState.user?.login);
} else {
  console.log('未登录');
}
```

### 在 Hook 中使用

```typescript
import { getAuthProvider } from './services/auth';

export function useAuth() {
  const auth = getAuthProvider();
  
  const login = async () => {
    await auth.startLogin();
  };
  
  const logout = () => {
    auth.logout();
  };
  
  return { login, logout, ...auth.getAuthState() };
}
```

### 统一的同步服务

```typescript
import * as GitHubSync from './services/githubSyncV2';

// 所有代码都使用这个统一的服务
await GitHubSync.startGitHubAuth();
await GitHubSync.handleOAuthCallback(code);
await GitHubSync.syncToGitHub(data);
```

## 环境检测

```typescript
function isTauriEnvironment(): boolean {
  return typeof window !== 'undefined' && '__TAURI__' in window;
}
```

- Tauri 环境：`window.__TAURI__` 对象存在
- Web 环境：`window.__TAURI__` 不存在

## 优势

### 1. 关注点分离
- 业务逻辑不需要关心具体的认证实现
- 认证提供者可以独立开发和测试

### 2. 易于扩展
- 添加新的认证方式（如其他 OAuth 提供商）只需实现接口
- 添加新的存储方式（如 Tauri Store）只需实现存储接口

### 3. 易于测试
- 可以创建 Mock 实现进行单元测试
- 不同环境可以独立测试

### 4. 类型安全
- 使用 TypeScript 接口确保所有实现遵循规范
- 编译时捕获错误

## 迁移计划

### 阶段 1: 创建抽象层（✅ 已完成）
- 定义接口 `IAuthProvider` 和 `IStorageProvider`
- 实现 `TauriAuthProvider` 和 `WebAuthProvider`
- 实现存储提供者

### 阶段 2: 适配现有代码
- 将现有的 `useGitHubSync` hook 迁移到新架构
- 保持 API 兼容性
- 逐步替换旧的 `githubSync.ts`

### 阶段 3: Web 后端实现
- 创建 Express/Fastify 后端服务
- 实现 `/api/auth/github/callback` 端点
- 实现 token 交换逻辑

### 阶段 4: 增强功能
- 实现 Tauri Store 加密存储
- 添加 token 刷新机制
- 添加多账号支持

## Web 后端示例

### Node.js + Express 示例

```javascript
// server/routes/auth.js
const express = require('express');
const router = express.Router();

const GITHUB_CLIENT_ID = process.env.GITHUB_CLIENT_ID;
const GITHUB_CLIENT_SECRET = process.env.GITHUB_CLIENT_SECRET;

router.post('/auth/github/callback', async (req, res) => {
  const { code } = req.body;
  
  try {
    // 交换 token
    const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        client_id: GITHUB_CLIENT_ID,
        client_secret: GITHUB_CLIENT_SECRET,
        code,
      }),
    });
    
    const { access_token } = await tokenResponse.json();
    
    // 获取用户信息
    const userResponse = await fetch('https://api.github.com/user', {
      headers: {
        Authorization: `token ${access_token}`,
      },
    });
    
    const user = await userResponse.json();
    
    res.json({
      token: access_token,
      user: {
        login: user.login,
        name: user.name,
        avatar_url: user.avatar_url,
      },
    });
  } catch (error) {
    res.status(500).json({ error: 'OAuth 认证失败' });
  }
});

module.exports = router;
```

## 文件结构

```
src/services/
├── auth/
│   ├── types.ts                        # 接口定义
│   ├── AuthFactory.ts                  # 工厂类
│   ├── index.ts                        # 统一导出
│   ├── providers/
│   │   ├── TauriAuthProvider.ts        # Tauri 实现
│   │   └── WebAuthProvider.ts          # Web 实现
│   └── storage/
│       ├── LocalStorageProvider.ts     # localStorage 实现
│       └── TauriStorageProvider.ts     # Tauri 存储实现
├── githubSync.ts                       # 旧版（向后兼容）
└── githubSyncV2.ts                     # 新版（使用抽象层）
```

## 安全注意事项

### 1. Client Secret 保护
- ❌ 绝不在前端代码中硬编码 Client Secret
- ✅ 桌面端：存储在 Rust 后端（编译后不可见）
- ✅ Web 端：存储在服务器环境变量

### 2. Token 存储
- 桌面端：考虑使用系统钥匙串（Tauri Store）
- Web 端：使用 HttpOnly Cookie（如果需要更高安全性）

### 3. HTTPS
- Web 部署必须使用 HTTPS
- GitHub OAuth 回调要求 HTTPS

## 测试策略

### 单元测试
```typescript
// 使用 Mock Provider 测试
class MockAuthProvider implements IAuthProvider {
  // 模拟实现...
}

test('should login successfully', async () => {
  const auth = new MockAuthProvider();
  const result = await auth.handleCallback('test-code');
  expect(result.user.login).toBe('testuser');
});
```

### 集成测试
- 在 Tauri 环境中测试完整的 OAuth 流程
- 在 Web 环境中测试完整的 OAuth 流程

## 相关资源

- [GitHub OAuth 文档](https://docs.github.com/en/developers/apps/building-oauth-apps)
- [Tauri 插件系统](https://tauri.app/v1/guides/features/plugin/)
- [设计模式：工厂模式](https://refactoring.guru/design-patterns/factory-method)
- [设计模式：策略模式](https://refactoring.guru/design-patterns/strategy)

