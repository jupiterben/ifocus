# è¿ç§»åˆ°è®¤è¯æŠ½è±¡å±‚æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å°†ç°æœ‰ä»£ç ä» `githubSync.ts` è¿ç§»åˆ°æ–°çš„è®¤è¯æŠ½è±¡å±‚ `githubSyncV2.ts`ã€‚

## ä¸ºä»€ä¹ˆè¦è¿ç§»ï¼Ÿ

### å½“å‰é—®é¢˜
- ä»£ç è€¦åˆï¼šè®¤è¯é€»è¾‘ä¸ Tauri ç¯å¢ƒå¼ºè€¦åˆ
- éš¾ä»¥æ‰©å±•ï¼šæ— æ³•æ”¯æŒ Web æœåŠ¡ç«¯éƒ¨ç½²
- æµ‹è¯•å›°éš¾ï¼šæ— æ³•è½»æ¾ mock è®¤è¯é€»è¾‘

### æ–°æ¶æ„ä¼˜åŠ¿
- âœ… æ”¯æŒå¤šç¯å¢ƒï¼šæ¡Œé¢ç«¯å’Œ Web ç«¯
- âœ… æ˜“äºæ‰©å±•ï¼šé€šè¿‡æ¥å£æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼
- âœ… æ˜“äºæµ‹è¯•ï¼šå¯ä»¥åˆ›å»º mock å®ç°
- âœ… ç±»å‹å®‰å…¨ï¼šTypeScript æ¥å£ä¿è¯å®ç°æ­£ç¡®

## è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1: æ›´æ–°å¯¼å…¥è¯­å¥

**æ—§ä»£ç  (`githubSync.ts`):**
```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  validateToken,
  type GitHubUser,
  type SyncData,
} from '../services/githubSync';
```

**æ–°ä»£ç  (`githubSyncV2.ts`):**
```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  validateToken,
  initializeAuth,  // æ–°å¢
  type GitHubUser,
  type SyncData,
} from '../services/githubSyncV2';
```

### æ­¥éª¤ 2: ä½¿ç”¨æ–°çš„åˆå§‹åŒ–æ–¹æ³•

**æ—§ä»£ç :**
```typescript
useEffect(() => {
  const stored = getStoredUser();
  setUser(stored);
  
  if (stored) {
    setIsValidating(true);
    validateToken()
      .then((isValid) => {
        // ...
      });
  }
}, []);
```

**æ–°ä»£ç ï¼ˆæ¨èï¼‰:**
```typescript
useEffect(() => {
  setIsValidating(true);
  
  // ä½¿ç”¨ç»Ÿä¸€çš„åˆå§‹åŒ–æ–¹æ³•
  initializeAuth()
    .then((authState) => {
      setUser(authState.user);
      if (!authState.isLoggedIn && getStoredUser()) {
        // Token å·²å¤±æ•ˆ
        setSyncError('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      }
    })
    .catch((error) => {
      console.error('åˆå§‹åŒ–è®¤è¯å¤±è´¥:', error);
    })
    .finally(() => {
      setIsValidating(false);
    });
}, []);
```

### æ­¥éª¤ 3: ä¿æŒå…¶ä»–ä»£ç ä¸å˜

ç”±äºæ–°çš„ `githubSyncV2.ts` ä¿æŒäº†ä¸æ—§ API ç›¸åŒçš„æ¥å£ï¼Œå…¶ä»–ä»£ç æ— éœ€ä¿®æ”¹ï¼š

```typescript
// è¿™äº› API å®Œå…¨å…¼å®¹
await startGitHubAuth();
await handleOAuthCallback(code);
await syncToGitHub(data);
const data = await syncFromGitHub();
clearAuth();
```

## å®Œæ•´ç¤ºä¾‹

### è¿ç§»å‰: `useGitHubSync.ts`

```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  validateToken,
  type GitHubUser,
  type SyncData,
} from '../services/githubSync';

export function useGitHubSync() {
  const [user, setUser] = useState<GitHubUser | null>(getStoredUser());
  
  useEffect(() => {
    const stored = getStoredUser();
    setUser(stored);
    
    if (stored) {
      validateToken().then((isValid) => {
        if (!isValid) {
          setUser(null);
        }
      });
    }
  }, []);
  
  // ... å…¶ä»–ä»£ç 
}
```

### è¿ç§»å: `useGitHubSync.ts`

```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  initializeAuth,  // æ–°å¢
  type GitHubUser,
  type SyncData,
} from '../services/githubSyncV2';

export function useGitHubSync() {
  const [user, setUser] = useState<GitHubUser | null>(null);
  
  useEffect(() => {
    // ä½¿ç”¨æ–°çš„åˆå§‹åŒ–æ–¹æ³•
    initializeAuth().then((authState) => {
      setUser(authState.user);
    });
  }, []);
  
  // ... å…¶ä»–ä»£ç ä¿æŒä¸å˜
}
```

## ç¯å¢ƒé…ç½®

### Tauri æ¡Œé¢ç«¯
æ— éœ€é¢å¤–é…ç½®ï¼Œä»£ç ä¼šè‡ªåŠ¨æ£€æµ‹ Tauri ç¯å¢ƒã€‚

### Web éƒ¨ç½²

å¦‚æœä½ è¦éƒ¨ç½²åˆ° Web æœåŠ¡å™¨ï¼Œéœ€è¦ï¼š

#### 1. åˆ›å»ºåç«¯ API

```javascript
// server.js
const express = require('express');
const app = express();

app.post('/api/auth/github/callback', async (req, res) => {
  const { code } = req.body;
  
  // äº¤æ¢ token
  const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
    method: 'POST',
    headers: { 'Accept': 'application/json' },
    body: JSON.stringify({
      client_id: process.env.GITHUB_CLIENT_ID,
      client_secret: process.env.GITHUB_CLIENT_SECRET,
      code,
    }),
  });
  
  const { access_token } = await tokenResponse.json();
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  const userResponse = await fetch('https://api.github.com/user', {
    headers: { Authorization: `token ${access_token}` },
  });
  
  const user = await userResponse.json();
  
  res.json({
    token: access_token,
    user: {
      login: user.login,
      name: user.name,
      avatar_url: user.avatar_url,
    },
  });
});

app.listen(3000);
```

#### 2. æ›´æ–° GitHub OAuth App è®¾ç½®

åœ¨ https://github.com/settings/developers ä¸­ï¼š
- **Tauri å›è°ƒ URL**: `ifocus://auth/callback`
- **Web å›è°ƒ URL**: `https://yourdomain.com/auth/callback`

#### 3. é…ç½®å‰ç«¯

```typescript
import { getAuthProvider } from './services/auth';

// æŒ‡å®šåç«¯ API URL
const authProvider = getAuthProvider('/api');
```

## æµ‹è¯•è¿ç§»

### 1. æµ‹è¯•æ¡Œé¢ç«¯
```bash
npm run tauri:dev
```

- ç™»å½•åŠŸèƒ½åº”è¯¥æ­£å¸¸å·¥ä½œ
- æ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š`ğŸ–¥ï¸ æ£€æµ‹åˆ° Tauri ç¯å¢ƒ`

### 2. æµ‹è¯• Web ç«¯ï¼ˆå¦‚æœéƒ¨ç½²ï¼‰
```bash
npm run build
npm start  # æˆ–ä½ çš„æœåŠ¡å™¨å¯åŠ¨å‘½ä»¤
```

- ç™»å½•åº”è¯¥é‡å®šå‘åˆ° GitHub
- å›è°ƒåº”è¯¥è¿”å›åº”ç”¨
- æ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š`ğŸŒ æ£€æµ‹åˆ° Web ç¯å¢ƒ`

## å¸¸è§é—®é¢˜

### Q1: è¿ç§»åç™»å½•å¤±è´¥
**A**: æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºï¼Œç¡®è®¤ä½¿ç”¨çš„æ˜¯æ­£ç¡®çš„ AuthProviderã€‚

### Q2: Web ç«¯ CORS é”™è¯¯
**A**: ç¡®ä¿åç«¯ API æ­£ç¡®é…ç½®äº† CORS å¤´ï¼š
```javascript
app.use(cors({
  origin: 'https://yourdomain.com',
  credentials: true,
}));
```

### Q3: Token éªŒè¯å¤±è´¥
**A**: æ£€æŸ¥ GitHub API å“åº”ï¼Œå¯èƒ½æ˜¯ï¼š
- Token å·²è¿‡æœŸ
- GitHub API é™æµ
- ç½‘ç»œé—®é¢˜

### Q4: æ—§çš„ localStorage æ•°æ®
**A**: æ–°æ—§ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨é”®ï¼Œæ•°æ®å¯ä»¥å¹³æ»‘è¿ç§»ã€‚

## å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```typescript
// å°†æ‰€æœ‰ githubSyncV2 æ”¹å› githubSync
import { ... } from '../services/githubSync';
```

æ—§ä»£ç ä¿æŒä¸å˜ï¼Œå¯ä»¥å®‰å…¨å›æ»šã€‚

## æ€§èƒ½å½±å“

- **å¯åŠ¨æ—¶é—´**: å¢åŠ  1 æ¬¡ API è°ƒç”¨ï¼ˆéªŒè¯ tokenï¼‰
- **å†…å­˜å ç”¨**: å¿½ç•¥ä¸è®¡ï¼ˆ< 1KBï¼‰
- **è¿è¡Œæ—¶æ€§èƒ½**: æ— å½±å“

## ä¸‹ä¸€æ­¥

è¿ç§»å®Œæˆåï¼Œè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **ä½¿ç”¨ Tauri Store æ’ä»¶**: æ›´å®‰å…¨çš„å­˜å‚¨
2. **å®ç° token åˆ·æ–°**: é¿å…é¢‘ç¹é‡æ–°ç™»å½•
3. **æ·»åŠ ç¦»çº¿æ”¯æŒ**: ç¼“å­˜æ•°æ®ï¼Œç¦»çº¿å¯ç”¨
4. **å®ç°å¤šè´¦å·**: æ”¯æŒåˆ‡æ¢ä¸åŒ GitHub è´¦å·

## ç›¸å…³æ–‡æ¡£

- [è®¤è¯å±‚æ¶æ„è®¾è®¡](./è®¤è¯å±‚æ¶æ„è®¾è®¡.md)
- [ç™»å½•çŠ¶æ€æŒä¹…åŒ–](./ç™»å½•çŠ¶æ€æŒä¹…åŒ–.md)
- [ç™»å½•çŠ¶æ€æµ‹è¯•æŒ‡å—](./ç™»å½•çŠ¶æ€æµ‹è¯•æŒ‡å—.md)

