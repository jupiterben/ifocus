# GitHub OAuth 测试步骤

## ✅ 已完成的配置

1. ✅ GitHub OAuth App Client ID: `Ov23liZpDAtVMTavdA3s`
2. ✅ Client Secret 已配置在 `.env` 文件
3. ✅ Deep Link 协议已注册: `ifocus://`
4. ✅ Tauri 后端 OAuth 处理模块已实现
5. ✅ 前端 OAuth 回调监听已实现
6. ✅ 单实例应用配置（防止重复启动）

## 📋 测试流程

### 1. 启动应用

```bash
pnpm tauri:dev
```

### 2. 打开 GitHub 登录

1. 点击应用右上角 **⚙️ 设置**
2. 找到 "🔐 GitHub 数据同步" 部分
3. 点击 **"🔑 使用 GitHub 登录"**

### 3. 浏览器授权

- 浏览器会自动打开 GitHub 授权页面
- 显示应用名称: **iFocus**
- 请求权限: **gist** (读写 Gist)
- 点击 **"Authorize"** 按钮

### 4. 观察回调

**预期行为**：

1. GitHub 授权后重定向到: `ifocus://auth/callback?code=xxxxx`
2. 浏览器可能显示"无法打开"或直接跳转
3. **应用会自动检测到回调**
4. 控制台输出：
   ```
   接收到 deep link: ifocus://auth/callback?code=xxx
   OAuth code 获取成功，开始认证...
   GitHub 登录成功: 你的用户名
   ```
5. 设置页面更新显示: **"已登录: 你的用户名"**
6. 系统通知: **"登录成功 - 欢迎, 你的用户名!"**

### 5. 测试数据同步

登录成功后测试：

1. **上传数据**：
   - 点击 "📤 上传到云端"
   - 等待同步完成
   - 查看提示: "数据已同步到 GitHub"

2. **验证 Gist**：
   - 访问 https://gist.github.com/
   - 应该看到一个新的私有 Gist: `ifocus-data.json`
   - 内容包含任务和设置数据

3. **下载数据**：
   - 点击 "📥 从云端下载"
   - 确认覆盖提示
   - 数据恢复成功

## 🔍 调试检查

### 查看前端日志

打开 DevTools Console (F12)，查找：
- ✅ "接收到 deep link"
- ✅ "OAuth code 获取成功"
- ✅ "GitHub 登录成功"

### 查看后端日志

终端中 Tauri 输出：
- ✅ Client Secret 加载成功
- ✅ HTTP 请求日志

### 手动测试后端命令

在 DevTools Console 运行：
```javascript
// 测试 OAuth 处理（需要实际的 code）
await window.__TAURI__.core.invoke('handle_github_oauth', { 
  code: '实际的授权码' 
});
```

## ⚠️ 常见问题

### A. 浏览器提示"无法打开应用"

**原因**：协议未注册

**解决**：
```bash
# 重新构建并安装
pnpm tauri:build
# 运行生成的安装包
```

### B. 回调没有反应

**检查**：
1. Console 是否有错误？
2. `.env` 文件在正确位置？
3. Client Secret 是否正确？

**尝试**：
```bash
# 重启开发服务器
pnpm tauri:dev
```

### C. Token 交换失败

**可能原因**：
- 网络问题
- Client Secret 错误
- GitHub API 限流

**临时方案**：使用 Token 登录
1. 创建 Personal Access Token
2. 在设置中输入 Token

## ✅ 成功标志

登录成功后，设置页面应该显示：

```
🔐 GitHub 数据同步

已登录: 你的用户名          [登出]

最后同步: 从未同步
[📤 上传到云端]  [📥 从云端下载]

提示：数据存储在 GitHub Gist 中，私有且安全
```

## 🎯 下一步

登录成功后：
1. 创建一些任务
2. 上传到云端
3. 在另一台设备登录
4. 下载数据验证同步

---

**遇到问题？** 查看详细文档：
- [OAUTH_QUICK_START.md](OAUTH_QUICK_START.md)
- [GITHUB_OAUTH_SETUP.md](GITHUB_OAUTH_SETUP.md)

