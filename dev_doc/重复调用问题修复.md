# ä¿®å¤ï¼šhandle_github_oauth è¢«è°ƒç”¨ä¸¤æ¬¡

## ğŸ” é—®é¢˜åˆ†æ

`handle_github_oauth` è¢«è°ƒç”¨äº†**ä¸¤æ¬¡**ï¼Œå¯¼è‡´ï¼š
1. ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šæˆåŠŸäº¤æ¢ token âœ…
2. ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šä½¿ç”¨ç›¸åŒçš„ codeï¼ŒGitHub è¿”å›é”™è¯¯ âŒ
   ```
   error: "bad_verification_code"
   error_description: "The code passed is incorrect or expired."
   ```

## ğŸ› æ ¹æœ¬åŸå› 

å‰ç«¯æœ‰**ä¸¤ä¸ªç›‘å¬å™¨**åŒæ—¶ç›‘å¬ deep-link äº‹ä»¶ï¼š

### ç›‘å¬å™¨ 1ï¼š`onOpenUrl`ï¼ˆæ­£ç¡®çš„ï¼‰
```typescript
// src/hooks/useGitHubSync.ts:89
unlistenDeepLink = await onOpenUrl((urls) => {
  for (const url of urls) {
    console.log('æ¥æ”¶åˆ° deep link:', url);
    processOAuthCallback(url);  // â† ç¬¬ä¸€æ¬¡è°ƒç”¨
  }
});
```

### ç›‘å¬å™¨ 2ï¼š`listen('deep-link-received')`ï¼ˆå¤šä½™çš„ï¼‰
```typescript
// src/hooks/useGitHubSync.ts:98
unlistenEvent = await listen<string>('deep-link-received', (event) => {
  console.log('æ¥æ”¶åˆ°å•å®ä¾‹è½¬å‘çš„ deep link:', event.payload);
  processOAuthCallback(event.payload);  // â† ç¬¬äºŒæ¬¡è°ƒç”¨
});
```

## ğŸ“Š äº‹ä»¶æµç¨‹ï¼ˆä¿®å¤å‰ï¼‰

```
ç”¨æˆ·æˆæƒ GitHub
    â†“
GitHub é‡å®šå‘: ifocus://auth/callback?code=xxx
    â†“
æ“ä½œç³»ç»Ÿå¯åŠ¨æ–°å®ä¾‹
    â†“
single-instance æ’ä»¶æ£€æµ‹åˆ°é‡å¤
    â†“
deep-link æ’ä»¶è‡ªåŠ¨å¤„ç† URL
    â†“
è§¦å‘ "deep-link://new-url" äº‹ä»¶
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  onOpenUrl ç›‘å¬å™¨    â”‚  'deep-link-received'â”‚
â”‚  (ç›‘å¬å™¨ 1)          â”‚  ç›‘å¬å™¨ (ç›‘å¬å™¨ 2)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                        â†“
processOAuthCallback  processOAuthCallback
    â†“                        â†“
handleOAuthCallback   handleOAuthCallback
    â†“                        â†“
invoke('handle_github_oauth', { code })
    â†“                        â†“
ç¬¬ä¸€æ¬¡ï¼šâœ… æˆåŠŸ          ç¬¬äºŒæ¬¡ï¼šâŒ å¤±è´¥
                        (code å·²è¢«ä½¿ç”¨)
```

## âœ… è§£å†³æ–¹æ¡ˆ

**ç§»é™¤å¤šä½™çš„ç›‘å¬å™¨**ï¼

ä½¿ç”¨äº†å®˜æ–¹çš„ `tauri-plugin-single-instance` (å¸¦ `deep-link` åŠŸèƒ½) åï¼Œdeep-link ä¼šè¢«**è‡ªåŠ¨å¤„ç†å’Œè½¬å‘**ï¼Œåªéœ€è¦ä¸€ä¸ª `onOpenUrl` ç›‘å¬å™¨ã€‚

### ä¿®å¤åçš„ä»£ç 

```typescript
// src/hooks/useGitHubSync.ts
useEffect(() => {
  let unlistenDeepLink: (() => void) | undefined;

  const setupListeners = async () => {
    // âœ… åªéœ€è¦è¿™ä¸€ä¸ªç›‘å¬å™¨
    // single-instance æ’ä»¶ä¼šè‡ªåŠ¨å¤„ç† deep-link è½¬å‘
    unlistenDeepLink = await onOpenUrl((urls) => {
      for (const url of urls) {
        console.log('æ¥æ”¶åˆ° deep link:', url);
        processOAuthCallback(url);
      }
    });
  };

  setupListeners().catch((error) => {
    console.error('è®¾ç½®ç›‘å¬å¤±è´¥:', error);
  });

  return () => {
    if (unlistenDeepLink) {
      unlistenDeepLink();
    }
  };
}, [processOAuthCallback]);
```

## ğŸ“Š äº‹ä»¶æµç¨‹ï¼ˆä¿®å¤åï¼‰

```
ç”¨æˆ·æˆæƒ GitHub
    â†“
GitHub é‡å®šå‘: ifocus://auth/callback?code=xxx
    â†“
æ“ä½œç³»ç»Ÿå¯åŠ¨æ–°å®ä¾‹
    â†“
single-instance æ’ä»¶æ£€æµ‹åˆ°é‡å¤
    â†“
deep-link æ’ä»¶è‡ªåŠ¨å¤„ç† URL
    â†“
è§¦å‘ "deep-link://new-url" äº‹ä»¶
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  onOpenUrl ç›‘å¬å™¨    â”‚ â† åªæœ‰ä¸€ä¸ªç›‘å¬å™¨
â”‚  (ç›‘å¬å™¨ 1)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
processOAuthCallback (åªè°ƒç”¨ä¸€æ¬¡)
    â†“
handleOAuthCallback
    â†“
invoke('handle_github_oauth', { code })
    â†“
âœ… æˆåŠŸï¼
```

## ğŸ¯ ä¸ºä»€ä¹ˆä¹‹å‰æœ‰ä¸¤ä¸ªç›‘å¬å™¨ï¼Ÿ

è¿™æ˜¯å†å²é—ç•™é—®é¢˜ï¼š

1. **æœ€åˆ**ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ `single-instance` åº“ï¼Œéœ€è¦æ‰‹åŠ¨ç›‘å¬å’Œè½¬å‘ deep-link
2. **ç°åœ¨**ï¼šä½¿ç”¨ Tauri å®˜æ–¹çš„ `single-instance` æ’ä»¶ï¼ˆå¸¦ `deep-link` åŠŸèƒ½ï¼‰ï¼Œ**è‡ªåŠ¨**å¤„ç†è½¬å‘
3. **é—®é¢˜**ï¼šå‡çº§åˆ°å®˜æ–¹æ’ä»¶åï¼Œå¿˜è®°ç§»é™¤æ‰‹åŠ¨ç›‘å¬çš„ä»£ç 

## ğŸ§ª éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨åº”ç”¨ï¼š
   ```bash
   pnpm tauri:dev
   ```

2. ç‚¹å‡» "ä½¿ç”¨ GitHub ç™»å½•"

3. åœ¨æµè§ˆå™¨ä¸­æˆæƒ

4. è§‚å¯Ÿæ—¥å¿—

### é¢„æœŸæ—¥å¿—ï¼ˆä¿®å¤åï¼‰

**å‰ç«¯æ—¥å¿—**ï¼ˆåº”è¯¥åªå‡ºç°ä¸€æ¬¡ï¼‰ï¼š
```
æ¥æ”¶åˆ° deep link: ifocus://auth/callback?code=xxx
ğŸ”— processOAuthCallback è¢«è°ƒç”¨
ğŸ“¥ æ¥æ”¶åˆ°çš„ URL: ifocus://auth/callback?code=xxx
âœ… OAuth code è·å–æˆåŠŸï¼Œå¼€å§‹è®¤è¯æµç¨‹...
ğŸ“¡ handleOAuthCallback å¼€å§‹å¤„ç†ï¼Œcode: xxx...
ğŸ”„ æ­£åœ¨è°ƒç”¨ Tauri åç«¯ handle_github_oauth å‘½ä»¤...
âœ… OAuth è®¤è¯æˆåŠŸï¼Œç”¨æˆ·: your_username
```

**åç«¯æ—¥å¿—**ï¼ˆåº”è¯¥åªå‡ºç°ä¸€æ¬¡ï¼‰ï¼š
```
æ£€æµ‹åˆ°æ–°å®ä¾‹å¯åŠ¨ï¼Œå‚æ•°: ["...", "ifocus://auth/callback?code=xxx"]
æ”¶åˆ° deep link äº‹ä»¶
å¼€å§‹å¤„ç† GitHub OAuthï¼Œcode: xxx...
ğŸ”„ å¼€å§‹äº¤æ¢ access token...
âœ… Access token äº¤æ¢æˆåŠŸ
âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ: your_username
GitHub OAuth æˆåŠŸï¼Œç”¨æˆ·: your_username
```

### ä¸åº”è¯¥å‡ºç°çš„æ—¥å¿—

âŒ ä¸åº”è¯¥å‡ºç°ä¸¤æ¬¡ï¼š
```
æ¥æ”¶åˆ° deep link: ...
æ¥æ”¶åˆ°å•å®ä¾‹è½¬å‘çš„ deep link: ...  â† è¿™è¡Œä¸åº”è¯¥å‡ºç°äº†
```

âŒ ä¸åº”è¯¥å‡ºç°é‡å¤è°ƒç”¨ï¼š
```
å¼€å§‹å¤„ç† GitHub OAuth, code: xxx...
å¼€å§‹å¤„ç† GitHub OAuth, code: xxx...  â† ä¸åº”è¯¥æœ‰ç¬¬äºŒæ¬¡
```

âŒ ä¸åº”è¯¥å‡ºç° code å·²ä½¿ç”¨çš„é”™è¯¯ï¼š
```
âŒ GitHub OAuth é”™è¯¯: bad_verification_code
```

## ğŸ“ æŠ€æœ¯è¯´æ˜

### single-instance æ’ä»¶çš„å·¥ä½œåŸç†

ä½¿ç”¨ `tauri-plugin-single-instance` (å¸¦ `deep-link` åŠŸèƒ½) æ—¶ï¼š

1. **æ£€æµ‹æ–°å®ä¾‹**ï¼šå½“æœ‰æ–°å®ä¾‹å¯åŠ¨æ—¶ï¼Œæ’ä»¶ä¼šæ‹¦æˆª
2. **æå–å‚æ•°**ï¼šä» `argv` ä¸­æå–å‘½ä»¤è¡Œå‚æ•°
3. **è¯†åˆ« deep-link**ï¼šæ£€æŸ¥å‚æ•°æ˜¯å¦åŒ¹é…é…ç½®çš„ schemes
4. **è‡ªåŠ¨è½¬å‘**ï¼šå°† deep-link URL è½¬å‘åˆ°ç¬¬ä¸€ä¸ªå®ä¾‹
5. **è§¦å‘äº‹ä»¶**ï¼šåœ¨ç¬¬ä¸€ä¸ªå®ä¾‹ä¸­è§¦å‘ `deep-link://new-url` äº‹ä»¶
6. **é€€å‡ºæ–°å®ä¾‹**ï¼šæ–°å®ä¾‹å®Œæˆä»»åŠ¡åé€€å‡º

**å…³é”®ç‚¹**ï¼šæ•´ä¸ªè¿‡ç¨‹æ˜¯**è‡ªåŠ¨**çš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨ç›‘å¬å’Œè½¬å‘ï¼

### ç›‘å¬å™¨çš„é€‰æ‹©

| ç›‘å¬å™¨ | ç”¨é€” | ä½•æ—¶ä½¿ç”¨ |
|--------|------|---------|
| `onOpenUrl()` | ç›‘å¬ deep-link æ’ä»¶çš„äº‹ä»¶ | âœ… æ€»æ˜¯ä½¿ç”¨ |
| `listen('deep-link-received')` | è‡ªå®šä¹‰äº‹ä»¶ï¼ˆæ‰‹åŠ¨è½¬å‘ï¼‰ | âŒ ä½¿ç”¨å®˜æ–¹æ’ä»¶æ—¶ä¸éœ€è¦ |

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âœ… `handle_github_oauth` è¢«è°ƒç”¨ä¸¤æ¬¡
- âœ… ç¬¬äºŒæ¬¡è°ƒç”¨å¤±è´¥ï¼ˆcode å·²ä½¿ç”¨ï¼‰

### åŸå› 
- âœ… ä¸¤ä¸ªç›‘å¬å™¨åŒæ—¶ç›‘å¬åŒä¸€ä¸ª deep-link äº‹ä»¶

### è§£å†³
- âœ… ç§»é™¤å¤šä½™çš„ `listen('deep-link-received')` ç›‘å¬å™¨
- âœ… åªä¿ç•™ `onOpenUrl()` ç›‘å¬å™¨

### æ•ˆæœ
- âœ… OAuth å›è°ƒåªå¤„ç†ä¸€æ¬¡
- âœ… ä¸å†å‡ºç° "code å·²ä½¿ç”¨" é”™è¯¯
- âœ… ç™»å½•æµç¨‹é¡ºç•…å®Œæˆ

ç°åœ¨ OAuth æµç¨‹åº”è¯¥å®Œç¾å·¥ä½œäº†ï¼ğŸ‰

