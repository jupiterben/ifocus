# è®¤è¯åŠŸèƒ½å¾…ä¼˜åŒ–é¡¹å®æ–½è®¡åˆ’

## ä¼˜å…ˆçº§åˆ†æ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | éš¾åº¦ | æ”¶ç›Š | å»ºè®®æ—¶é—´ |
|------|--------|------|------|----------|
| è¿ç§»ç°æœ‰ä»£ç ä½¿ç”¨ githubSyncV2 | ğŸ”´ ä¸­ | â­ ä½ | é«˜ | 2-4å°æ—¶ |
| Tauri Store åŠ å¯†å­˜å‚¨ | ğŸŸ¡ ä½ | â­â­ ä¸­ | ä¸­ | 4-6å°æ—¶ |
| Web æœåŠ¡ç«¯åç«¯ API | ğŸŸ¢ é«˜ï¼ˆå¦‚éœ€ Web éƒ¨ç½²ï¼‰ | â­â­â­ é«˜ | é«˜ | 8-12å°æ—¶ |
| Token åˆ·æ–°æœºåˆ¶ | ğŸŸ¡ ä½ | â­â­â­ é«˜ | ä¸­ | 6-8å°æ—¶ |

## ä»»åŠ¡ 1: è¿ç§»ç°æœ‰ä»£ç ä½¿ç”¨ githubSyncV2.ts

### çŠ¶æ€ï¼šå¯é€‰ï¼Œå»ºè®®æ‰§è¡Œ

### ä¸ºä»€ä¹ˆåšï¼Ÿ
- ç»Ÿä¸€ä½¿ç”¨æ–°çš„æŠ½è±¡å±‚æ¶æ„
- ä¸ºæœªæ¥ Web éƒ¨ç½²åšå‡†å¤‡
- ä»£ç æ›´æ¸…æ™°ï¼Œæ›´æ˜“ç»´æŠ¤

### å·¥ä½œé‡è¯„ä¼°
- **æ–‡ä»¶æ•°é‡**: 2ä¸ªä¸»è¦æ–‡ä»¶
- **é¢„è®¡æ—¶é—´**: 2-4å°æ—¶
- **é£é™©ç­‰çº§**: ä½ï¼ˆå‘åå…¼å®¹ï¼‰

### å®æ–½æ­¥éª¤

#### Step 1: æ›´æ–° `useGitHubSync.ts`

**å½“å‰å¯¼å…¥ï¼š**
```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  validateToken,
  type GitHubUser,
  type SyncData,
} from '../services/githubSync';
```

**ä¿®æ”¹ä¸ºï¼š**
```typescript
import {
  startGitHubAuth,
  handleOAuthCallback,
  syncToGitHub,
  syncFromGitHub,
  isLoggedIn,
  getStoredUser,
  clearAuth,
  initializeAuth,  // æ–°å¢
  type GitHubUser,
  type SyncData,
} from '../services/githubSyncV2';
```

#### Step 2: ä¼˜åŒ–åˆå§‹åŒ–é€»è¾‘

**å½“å‰ä»£ç ï¼š**
```typescript
useEffect(() => {
  const stored = getStoredUser();
  setUser(stored);
  
  if (stored) {
    setIsValidating(true);
    validateToken()
      .then((isValid) => {
        // ...
      });
  }
}, []);
```

**ä¼˜åŒ–ä¸ºï¼š**
```typescript
useEffect(() => {
  setIsValidating(true);
  
  initializeAuth()
    .then((authState) => {
      setUser(authState.user);
      if (!authState.isLoggedIn && getStoredUser()) {
        setSyncError('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      }
    })
    .catch((error) => {
      console.error('åˆå§‹åŒ–è®¤è¯å¤±è´¥:', error);
    })
    .finally(() => {
      setIsValidating(false);
    });
}, []);
```

#### Step 3: æµ‹è¯•éªŒè¯

```bash
# 1. æ¸…é™¤æ—§çš„ç™»å½•çŠ¶æ€
localStorage.clear()

# 2. å¯åŠ¨åº”ç”¨
npm run tauri:dev

# 3. æµ‹è¯•ç™»å½•æµç¨‹
# 4. æµ‹è¯•è‡ªåŠ¨ç™»å½•
# 5. æµ‹è¯•åŒæ­¥åŠŸèƒ½
```

#### Step 4: æ¸…ç†æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰

å¦‚æœç¡®è®¤æ–°ç‰ˆæœ¬ç¨³å®šï¼Œå¯ä»¥è€ƒè™‘åˆ é™¤ `githubSync.ts`ï¼ˆå»ºè®®ä¿ç•™ä¸€æ®µæ—¶é—´ä½œä¸ºå¤‡ä»½ï¼‰ã€‚

### é¢„æœŸæ”¶ç›Š
- âœ… ç»Ÿä¸€ä»£ç é£æ ¼
- âœ… æ›´å¥½çš„ç¯å¢ƒæ£€æµ‹
- âœ… ä¸º Web éƒ¨ç½²é“ºè·¯

---

## ä»»åŠ¡ 2: ä½¿ç”¨ Tauri Store æ’ä»¶å®ç°åŠ å¯†å­˜å‚¨

### çŠ¶æ€ï¼šå¯é€‰ï¼Œæå‡å®‰å…¨æ€§

### ä¸ºä»€ä¹ˆåšï¼Ÿ
- æå‡ token å­˜å‚¨å®‰å…¨æ€§
- ä½¿ç”¨ç³»ç»Ÿçº§åŠ å¯†
- ç¬¦åˆæ¡Œé¢åº”ç”¨å®‰å…¨æœ€ä½³å®è·µ

### å·¥ä½œé‡è¯„ä¼°
- **ä¾èµ–å®‰è£…**: éœ€è¦æ·»åŠ  Tauri Store æ’ä»¶
- **é¢„è®¡æ—¶é—´**: 4-6å°æ—¶
- **é£é™©ç­‰çº§**: ä¸­ï¼ˆéœ€è¦è¿ç§»æ•°æ®ï¼‰

### æŠ€æœ¯æ–¹æ¡ˆ

#### Step 1: å®‰è£…ä¾èµ–

```bash
# æ·»åŠ  Tauri Store æ’ä»¶
cargo add tauri-plugin-store --git https://github.com/tauri-apps/tauri-plugin-store

# å‰ç«¯ä¾èµ–
npm install @tauri-apps/plugin-store
```

#### Step 2: é…ç½® Tauri

**src-tauri/src/main.rs:**
```rust
use tauri_plugin_store::StoreBuilder;

fn main() {
    tauri::Builder::default()
        .plugin(tauri_plugin_store::Builder::default().build())
        // ... å…¶ä»–é…ç½®
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

#### Step 3: æ›´æ–° TauriStorageProvider

**src/services/auth/storage/TauriStorageProvider.ts:**
```typescript
import { Store } from '@tauri-apps/plugin-store';

export class TauriStorageProvider implements IStorageProvider {
  private store: Store;

  constructor() {
    // åˆ›å»ºåŠ å¯†çš„ store
    this.store = new Store('.ifocus-credentials.dat');
  }

  async setToken(token: string): Promise<void> {
    await this.store.set('github_access_token', token);
    await this.store.save();
  }

  async getToken(): Promise<string | null> {
    return await this.store.get('github_access_token') as string | null;
  }

  async setUser(user: GitHubUser): Promise<void> {
    await this.store.set('github_user', user);
    await this.store.save();
  }

  async getUser(): Promise<GitHubUser | null> {
    return await this.store.get('github_user') as GitHubUser | null;
  }

  async clear(): Promise<void> {
    await this.store.clear();
    await this.store.save();
  }
}
```

#### Step 4: æ•°æ®è¿ç§»ç­–ç•¥

```typescript
// åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡æ€§è¿ç§»
async function migrateToTauriStore() {
  const oldToken = localStorage.getItem('github_access_token');
  const oldUser = localStorage.getItem('github_user');
  
  if (oldToken || oldUser) {
    const store = new TauriStorageProvider();
    
    if (oldToken) {
      await store.setToken(oldToken);
    }
    if (oldUser) {
      await store.setUser(JSON.parse(oldUser));
    }
    
    // æ¸…é™¤æ—§æ•°æ®
    localStorage.removeItem('github_access_token');
    localStorage.removeItem('github_user');
    
    console.log('âœ… æ•°æ®å·²è¿ç§»åˆ°åŠ å¯†å­˜å‚¨');
  }
}
```

### æ³¨æ„äº‹é¡¹
- âš ï¸ Store API æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰åŒæ­¥è°ƒç”¨
- âš ï¸ éœ€è¦å¤„ç†æ•°æ®è¿ç§»ï¼Œé¿å…ç”¨æˆ·ä¸¢å¤±ç™»å½•çŠ¶æ€
- âš ï¸ æ–‡ä»¶ä¼šåŠ å¯†å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•

### é¢„æœŸæ”¶ç›Š
- âœ… Token åŠ å¯†å­˜å‚¨
- âœ… æå‡å®‰å…¨æ€§
- âœ… ç¬¦åˆæ¡Œé¢åº”ç”¨æœ€ä½³å®è·µ

---

## ä»»åŠ¡ 3: å®ç° Web æœåŠ¡ç«¯åç«¯ API

### çŠ¶æ€ï¼šå¦‚éœ€ Web éƒ¨ç½²åˆ™å¿…é¡»

### ä¸ºä»€ä¹ˆåšï¼Ÿ
- æ”¯æŒåœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½² Web ç‰ˆæœ¬
- ä¿æŠ¤ Client Secret ä¸æš´éœ²åœ¨å‰ç«¯
- å®ç°é›†ä¸­å¼æ•°æ®ç®¡ç†

### å·¥ä½œé‡è¯„ä¼°
- **æŠ€æœ¯æ ˆ**: Node.js + Express / Fastify / Nest.js
- **é¢„è®¡æ—¶é—´**: 8-12å°æ—¶
- **é£é™©ç­‰çº§**: é«˜ï¼ˆéœ€è¦æœåŠ¡å™¨éƒ¨ç½²ï¼‰

### æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: Express + TypeScriptï¼ˆæ¨èï¼‰

**é¡¹ç›®ç»“æ„ï¼š**
```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ auth.ts
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ cors.ts
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.ts
â”‚   â””â”€â”€ app.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**æ ¸å¿ƒä»£ç ï¼š**

```typescript
// server/src/routes/auth.ts
import express from 'express';
import fetch from 'node-fetch';

const router = express.Router();

const GITHUB_CLIENT_ID = process.env.GITHUB_CLIENT_ID!;
const GITHUB_CLIENT_SECRET = process.env.GITHUB_CLIENT_SECRET!;

// OAuth å›è°ƒç«¯ç‚¹
router.post('/auth/github/callback', async (req, res) => {
  const { code } = req.body;

  if (!code) {
    return res.status(400).json({ error: 'Missing code parameter' });
  }

  try {
    // 1. äº¤æ¢ access token
    const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        client_id: GITHUB_CLIENT_ID,
        client_secret: GITHUB_CLIENT_SECRET,
        code,
      }),
    });

    const tokenData = await tokenResponse.json();

    if (tokenData.error) {
      return res.status(400).json({
        error: 'OAuth failed',
        details: tokenData.error_description,
      });
    }

    const accessToken = tokenData.access_token;

    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const userResponse = await fetch('https://api.github.com/user', {
      headers: {
        Authorization: `token ${accessToken}`,
        'User-Agent': 'iFocus-App',
      },
    });

    const user = await userResponse.json();

    // 3. è¿”å›ç»“æœ
    res.json({
      token: accessToken,
      user: {
        login: user.login,
        name: user.name,
        avatar_url: user.avatar_url,
      },
    });
  } catch (error) {
    console.error('OAuth error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

export default router;
```

**ä¸»åº”ç”¨ï¼š**

```typescript
// server/src/app.ts
import express from 'express';
import cors from 'cors';
import authRoutes from './routes/auth';

const app = express();
const PORT = process.env.PORT || 3000;

// ä¸­é—´ä»¶
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true,
}));
app.use(express.json());

// è·¯ç”±
app.use('/api', authRoutes);

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
});
```

**ç¯å¢ƒå˜é‡ï¼š**

```bash
# .env
GITHUB_CLIENT_ID=Ov23liZpDAtVMTavdA3s
GITHUB_CLIENT_SECRET=your_secret_here
FRONTEND_URL=https://yourdomain.com
PORT=3000
```

#### æ–¹æ¡ˆ B: Serverless (Vercel / Netlify Functions)

**é€‚åˆåœºæ™¯ï¼š** å°è§„æ¨¡éƒ¨ç½²ï¼Œæ— éœ€ä¸“ç”¨æœåŠ¡å™¨

```typescript
// api/auth/github/callback.ts (Vercel Functions)
import type { VercelRequest, VercelResponse } from '@vercel/node';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { code } = req.body;

  try {
    const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        client_id: process.env.GITHUB_CLIENT_ID,
        client_secret: process.env.GITHUB_CLIENT_SECRET,
        code,
      }),
    });

    const { access_token } = await tokenResponse.json();

    const userResponse = await fetch('https://api.github.com/user', {
      headers: { Authorization: `token ${access_token}` },
    });

    const user = await userResponse.json();

    res.json({
      token: access_token,
      user: {
        login: user.login,
        name: user.name,
        avatar_url: user.avatar_url,
      },
    });
  } catch (error) {
    res.status(500).json({ error: 'OAuth failed' });
  }
}
```

#### Step 4: æ›´æ–° GitHub OAuth è®¾ç½®

åœ¨ https://github.com/settings/developers æ·»åŠ  Web å›è°ƒ URLï¼š

```
Authorization callback URL:
- https://yourdomain.com/auth/callback
- http://localhost:5173/auth/callback (å¼€å‘ç¯å¢ƒ)
```

#### Step 5: å‰ç«¯è·¯ç”±å¤„ç†

```typescript
// src/App.tsx æˆ–è·¯ç”±é…ç½®
import { useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';

function AuthCallback() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();

  useEffect(() => {
    const code = searchParams.get('code');
    if (code) {
      // ä½¿ç”¨ WebAuthProvider å¤„ç†å›è°ƒ
      handleOAuthCallback(code)
        .then(() => {
          navigate('/');
        })
        .catch((error) => {
          console.error('ç™»å½•å¤±è´¥:', error);
          navigate('/login');
        });
    }
  }, [searchParams, navigate]);

  return <div>æ­£åœ¨ç™»å½•...</div>;
}
```

### éƒ¨ç½²æ¸…å•

- [ ] åˆ›å»ºåç«¯æœåŠ¡
- [ ] é…ç½®ç¯å¢ƒå˜é‡
- [ ] è®¾ç½® CORS
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] é…ç½® HTTPS
- [ ] æ›´æ–° GitHub OAuth å›è°ƒ URL
- [ ] æ·»åŠ é”™è¯¯å¤„ç†
- [ ] å®ç° rate limiting
- [ ] æ·»åŠ ç›‘æ§å’Œå‘Šè­¦

### é¢„æœŸæ”¶ç›Š
- âœ… æ”¯æŒ Web éƒ¨ç½²
- âœ… Client Secret å®‰å…¨
- âœ… é›†ä¸­å¼è®¤è¯ç®¡ç†

---

## ä»»åŠ¡ 4: æ·»åŠ  Token åˆ·æ–°æœºåˆ¶

### çŠ¶æ€ï¼šå¯é€‰ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### ä¸ºä»€ä¹ˆåšï¼Ÿ
- GitHub Token å¯èƒ½è¿‡æœŸ
- å‡å°‘ç”¨æˆ·é‡æ–°æˆæƒçš„é¢‘ç‡
- æå‡ç”¨æˆ·ä½“éªŒ

### æŒ‘æˆ˜
âš ï¸ **GitHub OAuth ä¸æ”¯æŒ refresh token**

GitHub çš„ OAuth token æ˜¯æ°¸ä¹…æœ‰æ•ˆçš„ï¼ˆé™¤éè¢«æ’¤é”€ï¼‰ï¼Œæ‰€ä»¥æ ‡å‡†çš„ refresh token æœºåˆ¶ä¸é€‚ç”¨ã€‚

### æ›¿ä»£æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: é™é»˜é‡æ–°æˆæƒï¼ˆä¸æ¨èï¼‰
- é—®é¢˜ï¼šéœ€è¦ç”¨æˆ·äº¤äº’

#### æ–¹æ¡ˆ 2: Token æœ‰æ•ˆæœŸæ£€æµ‹
```typescript
// å®šæœŸæ£€æŸ¥ token æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
async function checkTokenHealth() {
  const token = getStoredToken();
  if (!token) return false;

  try {
    const response = await fetch('https://api.github.com/user', {
      headers: { Authorization: `token ${token}` },
    });

    if (response.status === 401) {
      // Token å·²å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
      clearAuth();
      return false;
    }

    return true;
  } catch (error) {
    return false;
  }
}

// åœ¨åº”ç”¨è¿è¡Œæ—¶å®šæœŸæ£€æŸ¥ï¼ˆå¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰
setInterval(checkTokenHealth, 60 * 60 * 1000);
```

#### æ–¹æ¡ˆ 3: ä½¿ç”¨ GitHub Appï¼ˆæ¨èé•¿æœŸæ–¹æ¡ˆï¼‰

GitHub App æ”¯æŒæ›´é«˜çº§çš„è®¤è¯æœºåˆ¶ï¼š

```typescript
// ä½¿ç”¨ GitHub App ä»£æ›¿ OAuth App
// 1. åˆ›å»º GitHub App
// 2. ä½¿ç”¨ Installation Tokenï¼ˆæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰
// 3. ä½¿ç”¨ JWT åˆ·æ–° Installation Token

// ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰
async function refreshInstallationToken(installationId: string) {
  const jwt = generateJWT(); // ä½¿ç”¨ç§é’¥ç”Ÿæˆ JWT
  
  const response = await fetch(
    `https://api.github.com/app/installations/${installationId}/access_tokens`,
    {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${jwt}`,
        Accept: 'application/vnd.github+json',
      },
    }
  );

  const { token } = await response.json();
  return token;
}
```

### å»ºè®®
ç”±äº GitHub OAuth çš„é™åˆ¶ï¼Œ**å»ºè®®æš‚ä¸å®æ–½æ­¤é¡¹**ï¼Œé™¤éï¼š
1. è¿ç§»åˆ° GitHub App
2. æˆ–å®ç°æ›´å¤æ‚çš„é™é»˜é‡æ–°æˆæƒæµç¨‹

### é¢„æœŸæ”¶ç›Š
- æœ‰é™ï¼ˆGitHub Token é»˜è®¤æ°¸ä¹…æœ‰æ•ˆï¼‰
- å¦‚ä½¿ç”¨ GitHub App åˆ™æ”¶ç›Šæ˜¾è‘—

---

## å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆå¦‚æœéœ€è¦ï¼‰
1. **Web æœåŠ¡ç«¯åç«¯ API** - å¦‚æœè®¡åˆ’ Web éƒ¨ç½²
2. **è¿ç§»ç°æœ‰ä»£ç ** - ä¸ºå…¶ä»–ä¼˜åŒ–é“ºè·¯

### çŸ­æœŸä¼˜åŒ–
3. **Tauri Store åŠ å¯†å­˜å‚¨** - æå‡å®‰å…¨æ€§

### é•¿æœŸä¼˜åŒ–
4. **Token åˆ·æ–°æœºåˆ¶** - è€ƒè™‘è¿ç§»åˆ° GitHub App

## æ€»æ—¶é—´ä¼°ç®—

- **æœ€å°å¯è¡Œæ–¹æ¡ˆ**: è¿ç§»ä»£ç ï¼ˆ2-4å°æ—¶ï¼‰
- **Web éƒ¨ç½²æ–¹æ¡ˆ**: ä¸Šè¿° + åç«¯ APIï¼ˆ10-16å°æ—¶ï¼‰
- **å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ**: ä¸Šè¿° + åŠ å¯†å­˜å‚¨ï¼ˆ14-22å°æ—¶ï¼‰

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹ï¼š

```bash
# ä»»åŠ¡ 1: è¿ç§»ä»£ç 
# 1. å¤‡ä»½ useGitHubSync.ts
# 2. ä¿®æ”¹å¯¼å…¥è¯­å¥
# 3. æ›´æ–°åˆå§‹åŒ–é€»è¾‘
# 4. æµ‹è¯•éªŒè¯

# ä»»åŠ¡ 2: åŠ å¯†å­˜å‚¨
# 1. å®‰è£… tauri-plugin-store
# 2. æ›´æ–° TauriStorageProvider
# 3. å®ç°æ•°æ®è¿ç§»
# 4. æµ‹è¯•éªŒè¯

# ä»»åŠ¡ 3: Web åç«¯
# 1. é€‰æ‹©æŠ€æœ¯æ ˆ
# 2. åˆ›å»ºåç«¯é¡¹ç›®
# 3. å®ç° OAuth ç«¯ç‚¹
# 4. éƒ¨ç½²åˆ°æœåŠ¡å™¨
```

éœ€è¦æˆ‘å¸®ä½ å®æ–½å…¶ä¸­æŸä¸ªä»»åŠ¡å—ï¼Ÿ

