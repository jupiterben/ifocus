# GitHub 登录状态持久化功能

## 功能概述

实现了 GitHub OAuth 登录状态的持久化保存，用户无需在每次启动应用时重新登录。

## 实现方案

### 1. Token 存储
- **位置**: `localStorage`
- **存储项**:
  - `github_access_token`: GitHub 访问令牌
  - `github_user`: 用户信息（JSON）
  - `github_gist_id`: Gist ID（用于数据同步）

### 2. 自动验证机制

应用启动时会自动执行以下流程：

```
应用启动
    ↓
检查 localStorage 中是否有 token
    ↓
如果有 → 调用 GitHub API 验证 token 是否有效
    ↓
如果有效 → 自动登录，更新用户信息
    ↓
如果无效 → 清除存储，提示用户重新登录
```

### 3. 核心代码

#### 3.1 Token 验证函数 (`src/services/githubSync.ts`)

```typescript
export async function validateToken(): Promise<boolean> {
  const token = getStoredToken();
  if (!token) {
    return false;
  }

  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        Authorization: `token ${token}`,
        'User-Agent': 'iFocus-App',
      },
    });

    if (!response.ok) {
      // Token 无效，清除存储
      clearAuth();
      return false;
    }

    // Token 有效，更新用户信息
    const user: GitHubUser = await response.json();
    storeUser(user);
    return true;
  } catch (error) {
    console.error('验证 token 失败:', error);
    return false;
  }
}
```

#### 3.2 自动验证逻辑 (`src/hooks/useGitHubSync.ts`)

```typescript
// 应用启动时验证 token
useEffect(() => {
  const stored = getStoredUser();
  setUser(stored);
  
  // 如果有存储的用户信息，验证 token 是否仍然有效
  if (stored) {
    setIsValidating(true);
    validateToken()
      .then((isValid) => {
        if (!isValid) {
          console.warn('⚠️ Token 已失效，已清除登录状态');
          setUser(null);
          setSyncError('登录已过期，请重新登录');
        } else {
          console.log('✅ Token 验证成功，自动登录');
          const updatedUser = getStoredUser();
          setUser(updatedUser);
        }
      })
      .finally(() => {
        setIsValidating(false);
      });
  }
}, []);
```

## 用户体验优化

### 1. 首次登录
- 用户点击"使用 GitHub 登录"按钮
- 在浏览器中完成 OAuth 授权
- 自动返回应用并完成登录
- Token 自动保存到 localStorage

### 2. 后续启动
- 应用自动读取存储的 token
- 在后台验证 token 有效性
- 如果有效：自动完成登录，用户无感知
- 如果无效：提示"登录已过期，请重新登录"

### 3. 验证状态显示
- 在设置页面显示"正在验证登录状态..."
- 避免用户在验证期间进行操作

## 安全性考虑

1. **Token 安全**
   - Token 仅存储在本地 localStorage
   - 不会上传到任何第三方服务器
   - 仅在与 GitHub API 通信时使用

2. **Token 失效处理**
   - GitHub Token 可能因以下原因失效：
     - 用户手动撤销授权
     - Token 过期
     - GitHub 安全策略变更
   - 一旦检测到 token 失效，立即清除本地存储

3. **API 调用限制**
   - GitHub API 有速率限制
   - validateToken 仅在应用启动时调用一次
   - 避免频繁验证导致 API 限制

## 测试场景

### 场景 1: 正常登录流程
1. 用户首次登录 → Token 保存
2. 关闭应用
3. 重新打开应用 → 自动登录成功 ✅

### 场景 2: Token 失效
1. 用户在 GitHub 撤销授权
2. 重新打开应用 → 显示"登录已过期"
3. 用户重新登录 → 获取新 Token ✅

### 场景 3: 网络异常
1. 应用启动时网络断开
2. Token 验证失败但不清除存储
3. 用户手动尝试同步时提示网络错误 ✅

## 后续优化建议

1. **Token 刷新机制**
   - 如果 GitHub 支持 refresh token，可以实现自动刷新
   - 避免用户频繁重新授权

2. **离线支持**
   - 在无网络环境下，保留 token 不清除
   - 仅在确认 token 无效（401 响应）时才清除

3. **多账号支持**
   - 允许用户切换不同的 GitHub 账号
   - 保存多个 token 映射

4. **加密存储**
   - 考虑使用 Tauri 的安全存储 API
   - 对 token 进行加密存储，提高安全性

## 修改文件列表

- ✅ `src/services/githubSync.ts` - 添加 validateToken 函数
- ✅ `src/hooks/useGitHubSync.ts` - 添加启动时自动验证逻辑
- ✅ `src/components/Settings.tsx` - 添加验证状态显示

## 相关文档

- [GitHub OAuth 文档](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps)
- [Tauri 安全最佳实践](https://tauri.app/v1/guides/security/best-practices)

